___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Meru Data CCM",
  "categories": [
    "TAG_MANAGEMENT",
    "PERSONALIZATION"
  ],
  "brand": {
    "id": "github.com_MeruData",
    "displayName": "Meru Data",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Meru Data CCM helps businesses comply with global privacy laws like GDPR and CCPA via a customizable cookie consent banner.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "scriptGuid",
    "displayName": "Meru Data CCM Script Guid",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "cookieConsentName",
    "displayName": "Cookie Consent Name",
    "simpleValueType": true
  },
  {
    "type": "GROUP",
    "name": "newDefaultSettings",
    "displayName": "Default Settings",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "PARAM_TABLE",
        "name": "defaultSettingRegionTable",
        "displayName": "",
        "paramTableColumns": [
          {
            "param": {
              "type": "TEXT",
              "name": "region",
              "simpleValueType": true,
              "displayName": "Region",
              "help": "Enter Region codes, expressed using country and/or subdivisions in ISO 3166-2 format.",
              "valueHint": "eg. US-CA, US-TX, CA, UK",
              "canBeEmptyString": true
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "analytics_storage",
              "displayName": "Analytics Storage",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied",
              "help": "Enables storage, such as cookies (web) or device identifiers (apps), related to analytics, for example, visit duration."
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "ad_storage",
              "displayName": "Ad Storage",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied",
              "help": "Enables storage, such as cookies (web) or device identifiers (apps), related to advertising."
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "ad_user_data",
              "displayName": "Ad User Data",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied",
              "help": "Sets consent for sending user data to Google for online advertising purposes."
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "ad_personalization",
              "displayName": "Ad Personalization",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied",
              "help": "Sets consent for personalized advertising."
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "functionality_storage",
              "displayName": "Functionality Storage",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied",
              "help": "Enables storage that supports the functionality of the website or app, for example, language settings"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "personalization_storage",
              "displayName": "Personalization Storage",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied",
              "help": "Enables storage related to personalization, for example, video recommendations"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "security_storage",
              "displayName": "Security Storage",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "granted",
              "help": "Enables storage related to security such as authentication functionality, fraud prevention, and other user protection."
            },
            "isUnique": false
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "additionalSettings",
    "displayName": "Additional Settings",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "ads_data_redaction",
        "checkboxText": "Redact Ads Data",
        "simpleValueType": true
      },
      {
        "type": "CHECKBOX",
        "name": "url_passthrough",
        "checkboxText": "Pass through URL parameters",
        "simpleValueType": true
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require("logToConsole");
log("data =", data);
const setDefaultConsentState = require("setDefaultConsentState");
const gtagSet = require("gtagSet");
const injectScript = require("injectScript");
const getCookieValues = require("getCookieValues");
const updateConsentState = require("updateConsentState");
const setInWindow = require("setInWindow");
const isConsentGranted = require("isConsentGranted");
const addEventCallback = require("addEventCallback");
const JSON = require("JSON");
const decode = require("decodeUriComponent");
const encodeUri = require("encodeUri");


const splitInput = (input) => {
  return input
    .split(",")
    .map((entry) => entry.trim())
    .filter((entry) => entry.length !== 0);
};


function setPreferencesFromRules(categories, gtagRules) {
  log(gtagRules);
  log(categories);
  let preferences = {
    ad_storage: "denied",
    ad_user_data: "denied",
    ad_personalization: "denied",
    analytics_storage: "denied",
    functionality_storage: "denied",
    personalization_storage: "denied",
    security_storage: "granted",
  };
  categories.forEach((optout) => {
    log(optout);
    gtagRules.forEach((rule) => {
      log(rule);
      log("rule.cm: " + rule.cm + ", optout: " + optout);
      if (rule.cm == optout) {
        preferences[rule.st] = "granted";
      }
    });
  });
  if (gtagRules[1].cm == null) {
    preferences[gtagRules[1].st] = preferences.ad_storage;
  }
  if (gtagRules[2].cm == null) {
    preferences[gtagRules[2].st] = preferences.ad_storage;
  }
  log(preferences);
  updateConsentState(preferences);
}

function onConsentUpdate() {
  log(data.cookieConsentName);
  const mppConsentCookie = getCookieValues(data.cookieConsentName)[0];
  log(mppConsentCookie);
  if (!!mppConsentCookie) {
    let consentCookie = JSON.parse(decode(mppConsentCookie));
    if (!!consentCookie.mappings) {
      let accepted_categories = consentCookie.categories;
      setPreferencesFromRules(accepted_categories, consentCookie.mappings);
    }
  }
}

const main = (data) => {

  gtagSet("ads_data_redaction", data.ads_data_redaction);
  gtagSet("url_passthrough", data.url_passthrough);
  gtagSet("developer_id.dYzUxZD", true);

  // Set default consent state(s)
  data.defaultSettingRegionTable.forEach((row) => {
    const region = splitInput(row.region);
    let defaultConsentStatus = {
      ad_storage: row.ad_storage,
      ad_user_data: row.ad_user_data,
      ad_personalization: row.ad_personalization,
      analytics_storage: row.analytics_storage,
      functionality_storage: row.functionality_storage,
      personalization_storage: row.personalization_storage,
      security_storage: row.security_storage,
      wait_for_update: 500,
    };
    if(region.length > 0) {
      defaultConsentStatus.region = region;
    }
    log(defaultConsentStatus);
    setDefaultConsentState(defaultConsentStatus);
  });

  onConsentUpdate();

  var scriptGuid = data.scriptGuid;
  log("scriptGuid =", scriptGuid);
  var ccmLoaderUrl =
    encodeUri("https://ccm.merudata.app/assets/" + scriptGuid + "/ccm_loader.min.js");
  log(ccmLoaderUrl);
  injectScript(
    ccmLoaderUrl,
    function onSuccess() {},
    function onFailure() {
      log("Failed to load /ccm.loader.js");
    }
  );
};

function buildCCMVariables() {
  addEventCallback(function (ctid, eventData) {
    const defaultConsent = {
      ad_storage: isConsentGranted("ad_storage"),
      ad_user_data: isConsentGranted("ad_user_data"),
      ad_personalization: isConsentGranted("ad_personalization"),
      analytics_storage: isConsentGranted("analytics_storage"),
      functionality_storage: isConsentGranted("functionality_storage"),
      personalization_storage: isConsentGranted("personalization_storage"),
      security_storage: isConsentGranted("security_storage"),
    };
    setInWindow("defaultCCMGtagConsent", defaultConsent, true);
    log("Tag count for container " + ctid + ": " + eventData.tags.length);
  });
}

main(data);
buildCCMVariables();
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ads_data_redaction"
              },
              {
                "type": 1,
                "string": "url_passthrough"
              },
              {
                "type": 1,
                "string": "developer_id.dYzUxZD"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "region"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "wait_for_update"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://ccm.merudata.app/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "mppCookie_Consent"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "defaultCCMGtagConsent"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_metadata",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 2/1/2025, 7:25:01 pm


